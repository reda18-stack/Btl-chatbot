<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nyx ChatBot</title>

<script src="https://cdn.tailwindcss.com"></script>

<style>
    /* --- BASE --- */
    :root { --purple: #9333ea; --purple-2: #a855f7; --dark: #0c001f; }
    html,body { height: 100%; margin: 0; }
    body {
        background: linear-gradient(135deg, #1f013d 0%, var(--dark) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        color: #fff;
        transition: all 0.4s ease;
        padding: 2rem;
    }

    /* --- GLASS --- */
    .glass-container {
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.06);
        box-shadow: 0 6px 30px rgba(0,0,0,0.35);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border-radius: 14px;
    }

    /* --- EYES ROW --- */
    #eyes {
        display: flex;
        gap: 2.5rem;
        margin-bottom: 1.75rem;
        align-items: center;
        justify-content: center;
        pointer-events: none; /* don't block clicks */
    }

    /* The purple squares (the "eyes") */
    .eye {
        width: 140px;
        height: 110px;
        background: var(--purple);
        border-radius: 20px;
        box-shadow: 0 0 30px var(--purple), 0 0 60px rgba(147,51,234,0.25);
        position: relative;
        transition: transform 0.08s linear, filter 0.18s ease, height 0.18s ease;
        will-change: transform;
        display: inline-block;
        /* center content if needed later */
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* states */
    .thinking { animation: pulse 0.9s infinite ease-in-out; }
    .reply { height: 70px; border-radius: 40px; filter: brightness(1.7); }
    .bouncing { animation: bounce 0.45s infinite alternate ease-in-out; }
    .talking { animation: bounce-chat 0.45s infinite alternate ease-in-out; }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(0.9); }
        100% { transform: scale(1); }
    }
    @keyframes bounce { 0% { transform: translateY(0); } 100% { transform: translateY(-10px); } }
    @keyframes bounce-chat { 0% { transform: translateY(0); } 100% { transform: translateY(-10px); } }

    /* --- CHAT UI --- */
    #chat-container {
        max-height: 60vh;
        overflow-y: auto;
        width: 420px;
    }

    #chat-container::-webkit-scrollbar { width: 6px; }
    #chat-container::-webkit-scrollbar-thumb { background: var(--purple); border-radius: 3px; }
    #chat-container::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); }

    .message {
        margin-bottom: 0.75rem;
        padding: 0.75rem;
        border-radius: 12px;
        max-width: 80%;
        line-height: 1.4;
        word-wrap: break-word;
    }
    .user-message {
        background: var(--purple);
        color: #fff;
        margin-left: auto;
        text-align: right;
        border-bottom-right-radius: 0;
    }
    .bot-message {
        background: #27272a;
        color: #fff;
        margin-right: auto;
        border-bottom-left-radius: 0;
    }

    /* header/nav */
    #header { position: fixed; top: 1rem; right: 1rem; z-index: 1000; }
    #nav-menu {
        position: fixed;
        top: 0;
        right: 0;
        height: 100vh;
        z-index: 990;
        transform: translateX(100%);
        transition: transform 0.28s ease-in-out;
        box-shadow: -5px 0 15px rgba(0,0,0,0.5);
        background: #111111;
        border-left: 1px solid rgba(147,51,234,0.12);
        padding: 2rem;
    }
    #nav-menu.active { transform: translateX(0); }
    .hidden { display: none !important; }

    /* small responsive */
    @media (max-width: 480px) {
        .eye { width: 100px; height: 80px; }
        #chat-container, form#input-form { width: 92vw; max-width: 420px; }
    }
</style>
</head>

<body>

    <div id="header" class="p-4">
        <div id="menu-icon" class="text-3xl cursor-pointer" style="color:var(--purple);">☰</div>
    </div>

    <div id="nav-menu" class="">
        <a href="#" id="about-link" class="block py-4 text-white hover:text-var(--purple)">About Nyx</a>
        <a href="#" id="contact-link" class="block py-4 text-white hover:text-var(--purple)">Contact Info</a>
        <button id="logout-button" class="block py-4 text-var(--purple) font-bold w-full text-left mt-4">Logout (Not Functional)</button>
    </div>

    <div id="eyes" class="mb-4">
        <div id="eyeL" class="eye" aria-hidden="true"></div>
        <div id="eyeR" class="eye" aria-hidden="true"></div>
    </div>

    <div id="chat-view" class="flex flex-col items-center gap-4">
        <div id="chat-container" class="glass-container p-4 rounded-xl">
            </div>

        <form id="input-form" class="flex w-[420px]">
            <input type="text" id="user-input" placeholder="Type your message..." required
                class="flex-grow p-3 border border-r-0 border-purple-500 rounded-l-lg bg-gray-900 text-white text-base focus:ring-2 focus:ring-purple-400 focus:outline-none">
            <button type="submit" id="send-button" class="px-5 py-3 bg-[#9333ea] text-white font-bold rounded-r-lg hover:bg-[#a855f7] transition-all duration-300 transform active:scale-95">
                Send
            </button>
        </form>
    </div>

<script>
    // --- Safe DOM references ---
    const chatView = document.getElementById("chat-view");
    const eyeL = document.getElementById("eyeL");
    const eyeR = document.getElementById("eyeR");
    const chatContainer = document.getElementById("chat-container");
    const inputForm = document.getElementById("input-form");
    const userInput = document.getElementById("user-input");
    const sendButton = document.getElementById("send-button");

    const header = document.getElementById("header");
    const menuIcon = document.getElementById("menu-icon");
    const navMenu = document.getElementById("nav-menu");
    const logoutButton = document.getElementById("logout-button");
    const aboutLink = document.getElementById("about-link");
    const contactLink = document.getElementById("contact-link");

    let chatHistory = [];
    const initialMessage = "Welcome to Nyx! How can I help you today?";

    // Set visual state on eyes
    function setState(state) {
        eyeL.className = "eye";
        eyeR.className = "eye";
        if (state) {
            eyeL.classList.add(state);
            eyeR.classList.add(state);
        }
    }

    // Eye tracking
    function initializeEyeTracking() {
        const MAX_DIST = 14;

        function onMove(clientX, clientY) {
            [eyeL, eyeR].forEach(eye => {
                const rect = eye.getBoundingClientRect();
                const cx = rect.left + rect.width / 2;
                const cy = rect.top + rect.height / 2;

                const dx = clientX - cx;
                const dy = clientY - cy;

                const angle = Math.atan2(dy, dx);
                const dist = Math.min(MAX_DIST, Math.hypot(dx, dy) * 0.06);

                const x = Math.cos(angle) * dist;
                const y = Math.sin(angle) * dist;

                eye.style.transform = `translate3d(${x}px, ${y}px, 0)`;
            });
        }

        document.addEventListener('mousemove', (e) => onMove(e.clientX, e.clientY));
        document.addEventListener('touchmove', (e) => {
            if (e.touches[0]) onMove(e.touches[0].clientX, e.touches[0].clientY);
        });

        document.addEventListener('mouseleave', () => {
            eyeL.style.transform = '';
            eyeR.style.transform = '';
        });
    }

    // Add message (TEXT ONLY NOW)
    // ADDED isNewMessage parameter for persistence
    function addMessage(text, sender, isNewMessage = true) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message');
        messageDiv.textContent = text;

        chatContainer.appendChild(messageDiv);
        
        if (isNewMessage) {
            chatHistory.push({ role: sender, text });
            // *** NEW LINE: Save history to sessionStorage ***
            sessionStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        }

        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Handle chat
    async function handleChat(event) {
        event.preventDefault();
        const userMessage = userInput.value.trim();
        if (!userMessage) return;

        addMessage(userMessage, 'user'); // isNewMessage is true by default
        userInput.value = '';
        sendButton.disabled = true;

        setState('thinking');

        let botResponse = "Error: Couldn't reach the server. Make sure /api/chat is running.";

        try {
            // chatHistory already contains the latest user message
            const historyToSend = chatHistory.slice(0, -1).map(m => ({
                role: m.role === 'bot' ? 'model' : m.role,
                parts: [{ text: m.text }]
            }));

            const resp = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: userMessage, history: historyToSend })
            });

            const data = await resp.json();

            if (resp.ok && data?.text) {
                botResponse = data.text;
                setState('reply');
                await new Promise(r => setTimeout(r, 420));
                setState('talking');
                addMessage(botResponse, 'bot');
            } else {
                // Remove the last user message from history if the API failed
                chatHistory.pop();
                sessionStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                addMessage("Server error: " + (data?.error || "Unknown error"), 'bot');
            }
        } catch (err) {
            // Remove the last user message from history if the fetch failed
            chatHistory.pop();
            sessionStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            addMessage(botResponse, 'bot');
        } finally {
            sendButton.disabled = false;
            setTimeout(() => setState(''), 800);
        }
    }

    // Nav
    function toggleMenu() { navMenu.classList.toggle('active'); }
    function handleLogout() { alert("Logout disabled in this build."); toggleMenu(); }
    function handleAbout() { alert("Nyx — a simple AI chatbot."); toggleMenu(); }
    function handleContact() { alert("No contact info yet."); toggleMenu(); }

    // Init
    function initializeChat() {
        inputForm.addEventListener('submit', handleChat);
        menuIcon.addEventListener('click', toggleMenu);
        logoutButton.addEventListener('click', handleLogout);
        aboutLink.addEventListener('click', e => { e.preventDefault(); handleAbout(); });
        contactLink.addEventListener('click', e => { e.preventDefault(); handleContact(); });

        // --- NEW: Load history from sessionStorage ---
        const savedHistory = sessionStorage.getItem('chatHistory');
        if (savedHistory) {
            try {
                const parsedHistory = JSON.parse(savedHistory);
                chatHistory = parsedHistory; // Restore array
                
                // Re-render old messages (passing false for isNewMessage)
                parsedHistory.forEach(m => addMessage(m.text, m.role, false));
            } catch (e) {
                console.error("Failed to parse saved history:", e);
                // Fallback to initial message if parsing fails
                addMessage(initialMessage, 'bot');
            }
        } else {
            // First load: Show welcome message
            addMessage(initialMessage, 'bot');
        }
        // --- END NEW: Load history from sessionStorage ---
    }

    initializeChat();
    initializeEyeTracking();
</script>


</body>
</html>
