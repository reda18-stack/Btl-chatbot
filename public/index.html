<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Btl AI Chat</title>

<script src="https://cdn.tailwindcss.com"></script>

<style>
    /* --- BASE --- */
    :root { --purple: #9333ea; --purple-2: #a855f7; --dark: #0c001f; }
    html,body { 
        height: 100%; 
        margin: 0; 
        padding: 0;
        overflow: hidden;
    }
    body {
        background: linear-gradient(135deg, #1f013d 0%, var(--dark) 100%);
        display: flex;
        flex-direction: column;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        color: #fff;
        padding: 0;
    }

    /* --- GLASS --- */
    .glass-container {
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.06);
        box-shadow: 0 6px 30px rgba(0,0,0,0.35);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border-radius: 14px;
    }
    
    /* --- MODAL --- */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 1rem;
    }
    .modal-content {
        background: #111111;
        padding: 1.5rem;
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.5);
    }
    .tool-button {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        padding: 0.75rem 1rem;
        margin-bottom: 0.5rem;
        background: rgba(147,51,234, 0.1);
        border: 1px solid rgba(147,51,234, 0.5);
        border-radius: 8px;
        color: white;
        font-weight: 500;
        transition: background 0.2s, transform 0.1s;
    }
    .tool-button:hover { background: rgba(147,51,234, 0.25); }
    .tool-button:active { transform: scale(0.98); }

    /* --- VOICE RECORDER MODAL --- */
    #voice-modal .modal-content {
        max-width: 350px;
        text-align: center;
    }
    #voice-visualizer {
        width: 100%;
        height: 100px;
        margin: 1rem 0;
        background: rgba(0,0,0,0.2);
        border-radius: 8px;
        position: relative;
        overflow: hidden;
    }
    #voice-wave {
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, var(--purple), transparent);
        opacity: 0.3;
        transform: scaleX(0);
        transform-origin: left;
        transition: transform 0.1s;
    }
    #voice-timer {
        font-size: 1.5rem;
        font-weight: bold;
        margin: 0.5rem 0;
        color: var(--purple);
    }
    .voice-controls {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 1rem;
    }
    .voice-button {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
    }
    #start-record {
        background: var(--purple);
        color: white;
    }
    #start-record:hover { background: var(--purple-2); }
    #stop-record {
        background: #dc2626;
        color: white;
        display: none;
    }
    #stop-record:hover { background: #ef4444; }
    #cancel-record {
        background: #6b7280;
        color: white;
    }
    #cancel-record:hover { background: #9ca3af; }

    /* --- EYES ROW (Chat Only) --- */
    #eyes {
        display: none; /* Hidden by default, shown when chat-view is active */
        gap: 1.5rem;
        margin-bottom: 1rem;
        align-items: center;
        justify-content: center;
        pointer-events: none;
    }

    .eye {
        width: 80px;
        height: 65px;
        background: var(--purple);
        border-radius: 15px;
        box-shadow: 0 0 20px var(--purple), 0 0 40px rgba(147,51,234,0.25);
        position: relative;
        transition: transform 0.08s linear, filter 0.18s ease, height 0.18s ease;
        will-change: transform;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* states */
    .thinking { animation: pulse 0.9s infinite ease-in-out; }
    .reply { height: 50px; border-radius: 25px; filter: brightness(1.7); }
    .talking { animation: bounce-chat 0.45s infinite alternate ease-in-out; }

    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(0.9); } 100% { transform: scale(1); } }
    @keyframes bounce-chat { 0% { transform: translateY(0); } 100% { transform: translateY(-5px); } }

    /* --- CHAT UI --- */
    #chat-view { 
        display: none; /* Hidden by default */ 
        flex: 1;
        flex-direction: column;
        width: 100%;
        padding: 0.5rem;
        box-sizing: border-box;
    }
    #chat-container {
        flex: 1;
        overflow-y: auto;
        width: 100%;
        padding: 0.5rem;
        box-sizing: border-box;
        margin-bottom: 0.5rem;
    }

    #chat-container::-webkit-scrollbar { width: 4px; }
    #chat-container::-webkit-scrollbar-thumb { background: var(--purple); border-radius: 2px; }
    #chat-container::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); }

    .message {
        margin-bottom: 0.75rem;
        padding: 0.75rem;
        border-radius: 12px;
        max-width: 85%;
        line-height: 1.4;
        word-wrap: break-word;
        white-space: pre-wrap; /* Preserve formatting for lists/summaries */
        font-size: 0.95rem;
    }
    .user-message {
        background: var(--purple);
        color: #fff;
        margin-left: auto;
        text-align: right;
        border-bottom-right-radius: 0;
    }
    .bot-message {
        background: #27272a;
        color: #fff;
        margin-right: auto;
        border-bottom-left-radius: 0;
    }
    .tool-message {
        background: #333;
        color: #ddd;
        font-style: italic;
        text-align: center;
        margin: 0.75rem auto;
        max-width: 95%;
        border-radius: 12px;
        font-size: 0.85rem;
    }
    .voice-message {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        background: rgba(147,51,234, 0.2);
        border-radius: 8px;
        margin-bottom: 0.5rem;
    }
    .voice-message .play-button {
        background: var(--purple);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s;
    }
    .voice-message .play-button:hover { background: var(--purple-2); }
    .voice-message .duration {
        font-size: 0.8rem;
        color: #ccc;
    }

    /* --- AUTH UI --- */
    #login-view {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        box-sizing: border-box;
    }
    .auth-card {
        padding: 2rem;
        width: 100%;
        max-width: 350px;
    }
    .input-field {
        width: 100%;
        padding: 0.75rem;
        margin-bottom: 1rem;
        border: 1px solid rgba(147,51,234,0.3);
        border-radius: 8px;
        background: rgba(0,0,0,0.3);
        color: white;
        transition: border-color 0.2s;
        font-size: 1rem;
        box-sizing: border-box;
    }
    .input-field:focus {
        border-color: var(--purple-2);
        outline: none;
        box-shadow: 0 0 0 2px rgba(147,51,234,0.5);
    }
    .auth-button {
        width: 100%;
        padding: 0.75rem;
        background: var(--purple);
        color: white;
        font-weight: bold;
        border-radius: 8px;
        transition: background-color 0.2s;
        font-size: 1rem;
        border: none;
    }
    .auth-button:hover { background: var(--purple-2); }
    .auth-button:disabled { background: #5a5a5a; cursor: not-allowed; }

    /* Nav */
    #header { 
        position: fixed; 
        top: 0.5rem; 
        right: 0.5rem; 
        z-index: 1000; 
        display: none; /* Hidden until logged in */
        padding: 0.5rem;
    }
    #nav-menu {
        position: fixed;
        top: 0;
        right: 0;
        height: 100vh;
        width: 70%;
        max-width: 300px;
        z-index: 990;
        transform: translateX(100%);
        transition: transform 0.28s ease-in-out;
        box-shadow: -5px 0 15px rgba(0,0,0,0.5);
        background: #111111;
        border-left: 1px solid rgba(147,51,234,0.12);
        padding: 2rem;
        box-sizing: border-box;
    }
    #nav-menu.active { transform: translateX(0); }
    
    /* Mobile-specific styles */
    .mobile-input-area {
        display: flex;
        width: 100%;
        padding: 0.5rem;
        box-sizing: border-box;
        background: rgba(0,0,0,0.3);
        border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    .mobile-button {
        padding: 0.75rem;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        border: none;
        transition: all 0.2s;
    }
    
    .mobile-input {
        flex: 1;
        padding: 0.75rem;
        border: 1px solid rgba(147,51,234,0.3);
        border-radius: 22px;
        background: rgba(0,0,0,0.5);
        color: white;
        margin: 0 0.5rem;
        font-size: 1rem;
        box-sizing: border-box;
    }
    
    .mobile-input:focus {
        border-color: var(--purple-2);
        outline: none;
    }
    
    /* Touch-friendly adjustments */
    button, .tool-button, .voice-button {
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
    }
    
    /* Safe area for notched phones */
    @supports(padding: max(0px)) {
        body {
            padding-left: max(0.5rem, env(safe-area-inset-left));
            padding-right: max(0.5rem, env(safe-area-inset-right));
            padding-top: max(0.5rem, env(safe-area-inset-top));
            padding-bottom: max(0.5rem, env(safe-area-inset-bottom));
        }
    }
</style>
</head>

<body>

    <!-- --- MODAL FOR GEMINI TOOLS --- -->
    <div id="tool-modal" class="modal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4 text-center" style="color:var(--purple-2);">‚ú® AI Tools ‚ú®</h3>
            <p class="text-sm text-gray-400 mb-4 text-center">Analyze your current conversation:</p>

            <button class="tool-button" onclick="handleGeminiTool('summarize')">
                <span>Summarize Conversation</span>
                <span class="text-lg text-yellow-300">üìù</span>
            </button>
            <button class="tool-button" onclick="handleGeminiTool('suggest')">
                <span>Suggest Next Steps</span>
                <span class="text-lg text-cyan-300">üí°</span>
            </button>
            <button class="tool-button" onclick="handleGeminiTool('tasks')">
                <span>Generate a Task List</span>
                <span class="text-lg text-green-300">‚úÖ</span>
            </button>
            
            <button class="auth-button mt-4 bg-gray-700 hover:bg-gray-600" onclick="document.getElementById('tool-modal').style.display = 'none'">
                Close
            </button>
        </div>
    </div>

    <!-- --- VOICE RECORDER MODAL --- -->
    <div id="voice-modal" class="modal" onclick="closeVoiceModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4 text-center" style="color:var(--purple-2);">üé§ Voice Message</h3>
            <p class="text-sm text-gray-400 mb-4 text-center">Tap record to start speaking</p>

            <div id="voice-visualizer">
                <div id="voice-wave"></div>
            </div>
            <div id="voice-timer">00:00</div>

            <div class="voice-controls">
                <button id="start-record" class="voice-button">Record</button>
                <button id="stop-record" class="voice-button">Stop</button>
                <button id="cancel-record" class="voice-button">Cancel</button>
            </div>
        </div>
    </div>


    <!-- NAV/HEADER (Only visible when logged in) -->
    <div id="header" class="p-4">
        <div id="menu-icon" class="text-3xl cursor-pointer" style="color:var(--purple);">‚ò∞</div>
    </div>

    <div id="nav-menu" class="">
        <a href="#" id="about-link" class="block py-4 text-white hover:text-var(--purple)">About Btl</a>
        <a href="#" id="contact-link" class="block py-4 text-white hover:text-var(--purple)">Contact Info</a>
        <button id="logout-button" class="block py-4 text-var(--purple) font-bold w-full text-left mt-4">Logout</button>
    </div>


    <!-- --- 1. AUTHENTICATION VIEW --- -->
    <div id="login-view">
        <h1 class="text-4xl font-extrabold mb-8 text-center" style="color:var(--purple-2);">Btl AI</h1>
        
        <div class="auth-card glass-container">

            <!-- Shared Error/Message Display -->
            <div id="auth-message" class="mb-4 p-3 bg-red-800/50 text-red-300 rounded-lg text-sm hidden"></div>

            <!-- Login Form -->
            <form id="login-form" class="auth-form">
                <h2 class="text-2xl font-semibold mb-6 text-white text-center">Login</h2>
                <input type="email" id="login-email" class="input-field" placeholder="Email" required>
                <input type="password" id="login-password" class="input-field" placeholder="Password" required>
                <button type="submit" id="login-button" class="auth-button">Sign In</button>
                <p class="mt-4 text-center text-sm text-gray-400">
                    Need an account? <a href="#" id="show-register" class="text-var(--purple) hover:text-var(--purple-2) font-medium">Register</a>
                </p>
            </form>

            <!-- Register Form (Initially Hidden) -->
            <form id="register-form" class="auth-form hidden">
                <h2 class="text-2xl font-semibold mb-6 text-white text-center">Register</h2>
                <input type="email" id="register-email" class="input-field" placeholder="Email" required>
                <input type="password" id="register-password" class="input-field" placeholder="Password" required>
                <input type="password" id="register-confirm-password" class="input-field" placeholder="Confirm Password" required>
                <button type="submit" id="register-button" class="auth-button">Create Account</button>
                <p class="mt-4 text-center text-sm text-gray-400">
                    Already have an account? <a href="#" id="show-login" class="text-var(--purple) hover:text-var(--purple-2) font-medium">Login</a>
                </p>
            </form>

        </div>
    </div>


    <!-- --- 2. CHAT VIEW (Initially Hidden) --- -->
    <div id="chat-view" class="flex flex-col items-center">
        <!-- Eyes row: the two purple squares -->
        <div id="eyes" class="mb-4">
            <div id="eyeL" class="eye" aria-hidden="true"></div>
            <div id="eyeR" class="eye" aria-hidden="true"></div>
        </div>

        <div id="chat-container" class="glass-container flex-1 w-full">
            <!-- messages go here -->
        </div>

        <!-- Mobile-optimized input area -->
        <div class="mobile-input-area">
            <button type="button" id="voice-button" class="mobile-button bg-gray-700 text-white" title="Voice Message">
                üé§
            </button>
            <input type="text" id="user-input" placeholder="Type a message..." class="mobile-input">
            <button type="button" id="tool-button" class="mobile-button bg-gray-700 text-white mr-2" title="AI Tools">
                ‚ú®
            </button>
            <button type="submit" id="send-button" class="mobile-button bg-[#9333ea] text-white">
                ‚û§
            </button>
        </div>
    </div>

<script>
    // --- Safe DOM references ---
    const chatView = document.getElementById("chat-view");
    const chatContainer = document.getElementById("chat-container");
    const userInput = document.getElementById("user-input");
    const sendButton = document.getElementById("send-button");
    const voiceButton = document.getElementById("voice-button");
    const toolButton = document.getElementById("tool-button");
    const toolModal = document.getElementById("tool-modal");
    const voiceModal = document.getElementById("voice-modal");
    const eyeL = document.getElementById("eyeL");
    const eyeR = document.getElementById("eyeR");

    // Voice recording elements
    const startRecordBtn = document.getElementById("start-record");
    const stopRecordBtn = document.getElementById("stop-record");
    const cancelRecordBtn = document.getElementById("cancel-record");
    const voiceTimer = document.getElementById("voice-timer");
    const voiceWave = document.getElementById("voice-wave");

    const header = document.getElementById("header");
    const navMenu = document.getElementById("nav-menu");
    const menuIcon = document.getElementById("menu-icon");
    const logoutButton = document.getElementById("logout-button");
    const aboutLink = document.getElementById("about-link");
    const contactLink = document.getElementById("contact-link");

    const loginView = document.getElementById("login-view");
    const loginForm = document.getElementById("login-form");
    const registerForm = document.getElementById("register-form");
    const authMessage = document.getElementById("auth-message");
    const showRegisterLink = document.getElementById("show-register");
    const showLoginLink = document.getElementById("show-login");

    let chatHistory = [];
    const initialMessage = "Hey there! üëã I'm Btl, your friendly AI assistant. I'm doing great today, thanks for asking! How are you feeling?";
    const API_BASE = ''; 

    // Voice recording variables
    let mediaRecorder = null;
    let audioChunks = [];
    let recordingTimer = null;
    let recordingSeconds = 0;
    let audioContext = null;
    let analyser = null;
    let microphone = null;
    let javascriptNode = null;

    // Human-like responses database
    const humanResponses = {
        greetings: [
            "Hey there! üëã It's lovely to see you!",
            "Hello! üòä Hope you're having a wonderful day!",
            "Hi! It's so nice to chat with you today!",
            "Hey! Great to connect with you! How's your day going?"
        ],
        howAreYou: [
            "I'm doing really well, thank you for asking! üòä Just here and ready to help you with anything you need. How about you? How's your day shaping up?",
            "I'm feeling fantastic today! The digital world is buzzing with possibilities. How are you feeling today?",
            "I'm great, thanks! Just excited to chat with you. How's everything on your end?",
            "Doing wonderfully! Each conversation makes my day better. How are you holding up?"
        ],
        gratitude: [
            "You're most welcome! üòä I'm always happy to help.",
            "Anytime! It's my pleasure to assist you.",
            "No problem at all! I'm glad I could help.",
            "You're very welcome! Don't hesitate to ask if you need anything else."
        ],
        farewell: [
            "Goodbye! It was wonderful chatting with you! Take care and hope to see you again soon! üëã",
            "Bye for now! Wishing you a fantastic day ahead! üòä",
            "See you later! Don't hesitate to come back if you need anything!",
            "Farewell! It was a pleasure talking with you. Stay awesome! ‚ú®"
        ],
        compliments: [
            "Aww, thank you! üòä You're making me blush!",
            "That's so kind of you to say! I really appreciate it!",
            "Thank you! You're pretty awesome yourself!",
            "You're too kind! I'm just here to help amazing people like you."
        ],
        encouragement: [
            "You've got this! I believe in you! üí™",
            "That sounds challenging, but I know you can handle it!",
            "Take it one step at a time - you're doing great!",
            "Remember to be kind to yourself. Progress, not perfection! üåü"
        ],
        unknown: [
            "That's an interesting question! Let me think about that for a moment...",
            "Hmm, I'm not entirely sure about that one. Could you tell me more?",
            "That's a great point! I'd love to learn more about your perspective.",
            "I appreciate you sharing that with me. Could you elaborate a bit more?"
        ]
    };

    // --- UTILITIES ---

    function showAuthMessage(message, isError = true) {
        authMessage.textContent = message;
        authMessage.classList.remove('hidden', 'bg-red-800/50', 'bg-green-800/50');
        authMessage.classList.add(isError ? 'bg-red-800/50' : 'bg-green-800/50');
        setTimeout(() => authMessage.classList.add('hidden'), 5000);
    }
    
    function setAuthButtonsDisabled(disabled) {
        document.getElementById("login-button").disabled = disabled;
        document.getElementById("register-button").disabled = disabled;
    }

    function setChatEnabled(enabled) {
        sendButton.disabled = !enabled;
        toolButton.disabled = !enabled;
        voiceButton.disabled = !enabled;
        userInput.disabled = !enabled;
    }

    function closeModal(event) {
        if (event.target === toolModal) {
            toolModal.style.display = 'none';
        }
    }

    function closeVoiceModal(event) {
        if (event.target === voiceModal) {
            stopRecording();
            voiceModal.style.display = 'none';
        }
    }

    // --- HUMAN-LIKE RESPONSE GENERATOR ---

    function generateHumanResponse(userMessage) {
        const message = userMessage.toLowerCase().trim();
        
        // Greetings
        if (message.match(/\b(hi|hello|hey|greetings|good morning|good afternoon|good evening)\b/)) {
            return getRandomResponse(humanResponses.greetings);
        }
        
        // How are you
        if (message.match(/\b(how are you|how do you do|how's it going|how are things)\b/)) {
            return getRandomResponse(humanResponses.howAreYou);
        }
        
        // Thank you
        if (message.match(/\b(thanks|thank you|thx|ty|appreciate it)\b/)) {
            return getRandomResponse(humanResponses.gratitude);
        }
        
        // Goodbye
        if (message.match(/\b(bye|goodbye|see you|farewell|cya|talk to you later)\b/)) {
            return getRandomResponse(humanResponses.farewell);
        }
        
        // Compliments
        if (message.match(/\b(you're awesome|you're great|you're amazing|you're helpful|you're smart|good job|well done)\b/)) {
            return getRandomResponse(humanResponses.compliments);
        }
        
        // Encouragement needed
        if (message.match(/\b(stressed|tired|exhausted|overwhelmed|anxious|worried|sad|upset|frustrated)\b/)) {
            return getRandomResponse(humanResponses.encouragement);
        }
        
        // Default response - try to be engaging
        return getRandomResponse(humanResponses.unknown);
    }

    function getRandomResponse(responses) {
        return responses[Math.floor(Math.random() * responses.length)];
    }

    // --- VIEW MANAGEMENT ---

    function showAuthView() {
        sessionStorage.removeItem('authToken');
        header.style.display = 'none';
        chatView.style.display = 'none';
        document.getElementById("eyes").style.display = 'none';
        loginView.style.display = 'flex';

        loginForm.reset();
        registerForm.reset();
        chatHistory = [];
        chatContainer.innerHTML = '';
    }

    function showChatView() {
        header.style.display = 'block';
        loginView.style.display = 'none';
        chatView.style.display = 'flex';
        document.getElementById("eyes").style.display = 'flex';

        loadChatHistory();
    }
    
    // --- CHAT LOGIC ---

    // Set visual state on eyes
    function setState(state) {
        eyeL.className = "eye";
        eyeR.className = "eye";
        if (state) {
            eyeL.classList.add(state);
            eyeR.classList.add(state);
        }
    }

    function addMessage(text, sender, isNewMessage = true, isTool = false, isVoice = false, voiceBlob = null) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', isTool ? 'tool-message' : (sender === 'user' ? 'user-message' : 'bot-message'));
        
        if (isVoice && voiceBlob) {
            // Create voice message UI
            const voiceMessageDiv = document.createElement('div');
            voiceMessageDiv.classList.add('voice-message');
            
            const playButton = document.createElement('div');
            playButton.classList.add('play-button');
            playButton.innerHTML = '‚ñ∂';
            playButton.onclick = () => playVoiceMessage(voiceBlob);
            
            const durationSpan = document.createElement('span');
            durationSpan.classList.add('duration');
            durationSpan.textContent = formatDuration(recordingSeconds);
            
            const textSpan = document.createElement('span');
            textSpan.textContent = text || "Voice message";
            
            voiceMessageDiv.appendChild(playButton);
            voiceMessageDiv.appendChild(durationSpan);
            voiceMessageDiv.appendChild(textSpan);
            
            messageDiv.appendChild(voiceMessageDiv);
        } else {
            messageDiv.textContent = text;
        }

        chatContainer.appendChild(messageDiv);
        
        if (isNewMessage && !isTool) {
            chatHistory.push({ 
                role: sender, 
                text,
                isVoice: isVoice,
                voiceBlob: isVoice ? URL.createObjectURL(voiceBlob) : null
            });
            sessionStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        }

        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    function loadChatHistory() {
        const savedHistory = sessionStorage.getItem('chatHistory');
        if (savedHistory) {
            try {
                const parsedHistory = JSON.parse(savedHistory);
                chatHistory = parsedHistory; 
                // Re-render old messages (passing false for isNewMessage)
                parsedHistory.forEach(m => {
                    if (m.isVoice && m.voiceBlob) {
                        // Convert the string back to a blob URL
                        fetch(m.voiceBlob)
                            .then(res => res.blob())
                            .then(blob => {
                                addMessage(m.text, m.role, false, false, true, blob);
                            })
                            .catch(() => {
                                // If blob loading fails, show text only
                                addMessage(m.text || "Voice message", m.role, false);
                            });
                    } else {
                        addMessage(m.text, m.role, false);
                    }
                });
                if (parsedHistory.length === 0) {
                    addMessage(initialMessage, 'bot');
                }
            } catch (e) {
                console.error("Failed to parse saved history:", e);
                addMessage(initialMessage, 'bot');
            }
        } else {
            addMessage(initialMessage, 'bot');
        }
    }

    async function handleChat(event) {
        if (event) event.preventDefault();
        const userMessage = userInput.value.trim();
        if (!userMessage) return;

        addMessage(userMessage, 'user');
        userInput.value = '';
        setChatEnabled(false);

        const authToken = sessionStorage.getItem('authToken');
        if (!authToken) {
            showAuthMessage("Session expired. Please log in again.", true);
            showAuthView();
            return;
        }

        setState('thinking');

        try {
            // For simple conversational responses, use human-like responses
            // For complex queries, use the AI API
            let botResponse;
            
            if (userMessage.length < 50 && 
                (userMessage.match(/\b(hi|hello|hey|how are you|thanks|thank you|bye|goodbye|you're|good)\b/i) || 
                 userMessage.includes('?'))) {
                
                // Use human-like response for simple conversational messages
                botResponse = generateHumanResponse(userMessage);
                
                // Simulate typing delay for more natural feel
                setTimeout(() => {
                    setState('reply');
                    setTimeout(() => {
                        setState('talking');
                        addMessage(botResponse, 'bot');
                        setChatEnabled(true);
                        setTimeout(() => setState(''), 800);
                    }, 420);
                }, 800 + Math.random() * 800);
                
            } else {
                // Use AI for complex queries
                const historyToSend = chatHistory.slice(0, -1).map(m => ({
                    role: m.role === 'bot' ? 'model' : m.role,
                    parts: [{ text: m.text }]
                }));

                const resp = await fetch(API_BASE + '/api/chat', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}` 
                    },
                    body: JSON.stringify({ prompt: userMessage, history: historyToSend })
                });

                const data = await resp.json();

                if (resp.ok && data?.text) {
                    setState('reply');
                    await new Promise(r => setTimeout(r, 420));
                    setState('talking');
                    addMessage(data.text, 'bot');
                } else if (resp.status === 401) {
                    showAuthMessage("Your session expired. Please log in.", true);
                    sessionStorage.removeItem('chatHistory');
                    showAuthView();
                } else {
                    chatHistory.pop();
                    sessionStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                    addMessage("I'm having trouble connecting right now. Could you try again in a moment?", 'bot');
                }
                setChatEnabled(true);
                setTimeout(() => setState(''), 800);
            }
        } catch (err) {
            console.error('Chat error:', err);
            chatHistory.pop();
            sessionStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            addMessage("I seem to be having connection issues. Let's try that again!", 'bot');
            setChatEnabled(true);
            setTimeout(() => setState(''), 800);
        }
    }

    // --- VOICE MESSAGE LOGIC ---

    function formatDuration(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function updateTimer() {
        recordingSeconds++;
        voiceTimer.textContent = formatDuration(recordingSeconds);
    }

    function startRecording() {
        // Reset state
        audioChunks = [];
        recordingSeconds = 0;
        voiceTimer.textContent = "00:00";
        voiceWave.style.transform = "scaleX(0)";
        
        // Show stop button, hide start button
        startRecordBtn.style.display = 'none';
        stopRecordBtn.style.display = 'block';
        
        // Start timer
        recordingTimer = setInterval(updateTimer, 1000);
        
        // Request microphone access
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                // Set up audio context for visualization
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);
                
                analyser.smoothingTimeConstant = 0.8;
                analyser.fftSize = 1024;
                
                microphone.connect(analyser);
                analyser.connect(javascriptNode);
                javascriptNode.connect(audioContext.destination);
                
                javascriptNode.onaudioprocess = function() {
                    const array = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(array);
                    const values = array.reduce((a, b) => a + b) / array.length;
                    
                    // Update visualization
                    const scale = Math.min(1, values / 100);
                    voiceWave.style.transform = `scaleX(${scale})`;
                };
                
                // Set up media recorder
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    // Clean up audio context
                    if (javascriptNode) javascriptNode.disconnect();
                    if (microphone) microphone.disconnect();
                    if (analyser) analyser.disconnect();
                    if (audioContext) audioContext.close();
                    
                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                    
                    // Create audio blob
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    
                    // Send voice message
                    sendVoiceMessage(audioBlob);
                };
                
                // Start recording
                mediaRecorder.start();
            })
            .catch(err => {
                console.error('Error accessing microphone:', err);
                alert('Could not access your microphone. Please check permissions.');
                stopRecording();
            });
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
        }
        
        // Reset UI
        clearInterval(recordingTimer);
        startRecordBtn.style.display = 'block';
        stopRecordBtn.style.display = 'none';
        voiceWave.style.transform = "scaleX(0)";
        
        // Close modal
        voiceModal.style.display = 'none';
    }

    function cancelRecording() {
        stopRecording();
        voiceModal.style.display = 'none';
    }

    function playVoiceMessage(blob) {
        const audio = new Audio(URL.createObjectURL(blob));
        audio.play();
    }

    async function sendVoiceMessage(audioBlob) {
        setChatEnabled(false);
        setState('thinking');
        
        // For now, we'll just add a placeholder message
        // In a real implementation, you would send the audio to a speech-to-text API
        // and then send the transcribed text to the chatbot
        
        addMessage("Voice message", 'user', true, false, true, audioBlob);
        
        // Simulate processing time with human-like response
        setTimeout(() => {
            setState('reply');
            setTimeout(() => {
                setState('talking');
                addMessage("Thanks for the voice message! I heard you loud and clear. In a full implementation, I'd be able to understand and respond to what you said! üòä", 'bot');
                setChatEnabled(true);
                setTimeout(() => setState(''), 800);
            }, 420);
        }, 1500);
    }

    // --- NEW GEMINI TOOL LOGIC ---

    async function handleGeminiTool(toolType) {
        toolModal.style.display = 'none';

        if (chatHistory.length <= 1) { // Only the initial welcome message
            addMessage("Our conversation is just getting started! Let's chat a bit more first. üòä", 'bot', true, true);
            return;
        }

        const authToken = sessionStorage.getItem('authToken');
        if (!authToken) {
            showAuthMessage("Session expired. Please log in again.", true);
            showAuthView();
            return;
        }

        addMessage(`Running AI Tool: ${toolType.charAt(0).toUpperCase() + toolType.slice(1)}...`, 'system', false, true);
        setChatEnabled(false);
        setState('thinking');

        try {
            const resp = await fetch(API_BASE + `/api/tool/${toolType}`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}` 
                },
                // Send the full current chat history for analysis
                body: JSON.stringify({ history: chatHistory })
            });

            const data = await resp.json();

            if (resp.ok && data?.text) {
                setState('reply');
                await new Promise(r => setTimeout(r, 420));
                setState('talking');
                addMessage(data.text, 'bot');
            } else if (resp.status === 401) {
                showAuthMessage("Your session expired. Please log in.", true);
                sessionStorage.removeItem('chatHistory');
                showAuthView();
            } else {
                addMessage(`Hmm, I'm having a bit of trouble with that tool right now. Could we try again in a moment?`, 'system', false, true);
            }
        } catch (err) {
            console.error('Tool error:', err);
            addMessage("I'm having connection issues with the tools right now. Let me try to reconnect!", 'system', false, true);
        } finally {
            setChatEnabled(true);
            setTimeout(() => setState(''), 800);
        }
    }


    // --- AUTHENTICATION LOGIC ---

    async function handleAuth(event, endpoint) {
        event.preventDefault();
        setAuthButtonsDisabled(true);
        authMessage.classList.add('hidden');

        const formId = endpoint === 'login' ? 'login-' : 'register-';
        const email = document.getElementById(formId + 'email').value;
        const password = document.getElementById(formId + 'password').value;
        const confirmPassword = endpoint === 'register' ? document.getElementById('register-confirm-password').value : null;

        if (endpoint === 'register' && password !== confirmPassword) {
            showAuthMessage("Passwords do not match.", true);
            setAuthButtonsDisabled(false);
            return;
        }

        try {
            const payload = { email, password };
            if (endpoint === 'register') payload.username = email;

            const resp = await fetch(API_BASE + `/api/auth/${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await resp.json();

            if (resp.ok && data.token) {
                sessionStorage.setItem('authToken', data.token);
                sessionStorage.removeItem('chatHistory'); 
                showChatView();
            } else {
                showAuthMessage(data.message || `Authentication failed: ${data.error || 'Unknown error'}`, true);
            }
        } catch (err) {
            showAuthMessage("Network error. Could not connect to the authentication server.", true);
            console.error(err);
        } finally {
            setAuthButtonsDisabled(false);
        }
    }

    // --- INITIALIZATION ---

    function initializeApp() {
        // --- Form Submission Handlers ---
        loginForm.addEventListener('submit', (e) => handleAuth(e, 'login'));
        registerForm.addEventListener('submit', (e) => handleAuth(e, 'register'));

        // --- Auth View Toggles ---
        showRegisterLink.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
        });
        showLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
        });

        // --- Chat & Nav Handlers ---
        sendButton.addEventListener('click', handleChat);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleChat();
            }
        });
        
        voiceButton.addEventListener('click', () => { 
            if (voiceButton.disabled) return;
            voiceModal.style.display = 'flex'; 
        });
        
        toolButton.addEventListener('click', () => { 
            if (toolButton.disabled) return;
            toolModal.style.display = 'flex'; 
        });
        
        // Voice recording handlers
        startRecordBtn.addEventListener('click', startRecording);
        stopRecordBtn.addEventListener('click', stopRecording);
        cancelRecordBtn.addEventListener('click', cancelRecording);
        
        menuIcon.addEventListener('click', () => navMenu.classList.toggle('active'));
        logoutButton.addEventListener('click', () => { 
            sessionStorage.removeItem('authToken'); 
            sessionStorage.removeItem('chatHistory'); 
            navMenu.classList.remove('active');
            showAuthView(); 
        });

        // Simple alerts for nav links
        aboutLink.addEventListener('click', e => { e.preventDefault(); alert("Btl ‚Äî your friendly AI assistant who cares! üòä"); navMenu.classList.remove('active'); });
        contactLink.addEventListener('click', e => { e.preventDefault(); alert("Feel free to reach out anytime! I'm always here to help. üíú"); navMenu.classList.remove('active'); });

        // --- Initial Auth Check ---
        const token = sessionStorage.getItem('authToken');
        if (token) {
            showChatView();
        } else {
            showAuthView();
        }

        // Mobile-specific optimizations
        initializeMobileOptimizations();
    }

    // Mobile-specific optimizations
    function initializeMobileOptimizations() {
        // Prevent zoom on input focus
        userInput.addEventListener('focus', () => {
            document.body.style.zoom = "1.0";
        });
        
        // Handle viewport height changes on mobile
        function setViewportHeight() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        
        setViewportHeight();
        window.addEventListener('resize', setViewportHeight);
        window.addEventListener('orientationchange', setViewportHeight);
        
        // Improved touch interactions
        document.addEventListener('touchstart', function() {}, {passive: true});
    }

    initializeApp();
</script>

</body>
</html>
