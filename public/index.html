<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PWA Meta Tags -->
<meta name="application-name" content="Btl AI">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Btl AI">
<meta name="description" content="Your friendly AI assistant with human-like conversations">
<meta name="format-detection" content="telephone=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="msapplication-config" content="/icons/browserconfig.xml">
<meta name="msapplication-TileColor" content="#9333ea">
<meta name="msapplication-tap-highlight" content="no">
<meta name="theme-color" content="#9333ea">

<!-- Apple Touch Icons -->
<link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="152x152" href="/icons/touch-icon-ipad.png">
<link rel="apple-touch-icon" sizes="180x180" href="/icons/touch-icon-iphone-retina.png">
<link rel="apple-touch-icon" sizes="167x167" href="/icons/touch-icon-ipad-retina.png">

<!-- PWA Manifest -->
<link rel="manifest" href="/manifest.json">

<!-- Theme Color -->
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#f8fafc">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0c001f">
<title>Btl AI ChatBot</title>

<script src="https://cdn.tailwindcss.com"></script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7656082455176043"
     crossorigin="anonymous"></script>
<style>
    /* --- BASE --- */
    :root { 
        --purple: #9333ea; 
        --purple-2: #a855f7; 
        --dark: #0c001f;
        --light-bg: #f8fafc;
        --light-card: #ffffff;
        --light-text: #1e293b;
        --light-border: #e2e8f0;
    }
    
    [data-theme="light"] {
        --bg-primary: var(--light-bg);
        --bg-card: var(--light-card);
        --text-primary: var(--light-text);
        --border-color: var(--light-border);
    }
    
    [data-theme="dark"] {
        --bg-primary: #0c001f;
        --bg-card: rgba(17, 17, 17, 0.95);
        --text-primary: #ffffff;
        --border-color: rgba(255, 255, 255, 0.1);
    }
    
    html,body { 
        height: 100%; 
        margin: 0; 
        overflow: hidden;
    }
    
    body {
        background: linear-gradient(-45deg, #1f013d, #0c001f, #2d1b69, #0c001f);
        background-size: 400% 400%;
        animation: gradient 15s ease infinite;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        color: var(--text-primary);
        transition: all 0.4s ease;
        padding: 2rem;
        position: relative;
    }

    body[data-theme="light"] {
        background: linear-gradient(-45deg, #e0e7ff, #c7d2fe, #ddd6fe, #c7d2fe);
        color: var(--text-primary);
    }

    /* Animated background */
    @keyframes gradient {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    /* --- GLASS --- */
    .glass-container {
        background: rgba(255,255,255,0.08);
        border: 1px solid rgba(255,255,255,0.12);
        box-shadow: 0 8px 32px rgba(0,0,0,0.4),
                    0 0 0 1px rgba(147, 51, 234, 0.1),
                    inset 0 0 0 1px rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-radius: 20px;
    }

    [data-theme="light"] .glass-container {
        background: rgba(255, 255, 255, 0.7);
        border: 1px solid rgba(147, 51, 234, 0.2);
        box-shadow: 0 8px 32px rgba(147, 51, 234, 0.1),
                    0 0 0 1px rgba(147, 51, 234, 0.1),
                    inset 0 0 0 1px rgba(255, 255, 255, 0.8);
        color: var(--text-primary);
    }
    
    /* --- MODAL --- */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 1rem;
        backdrop-filter: blur(5px);
    }

    [data-theme="light"] .modal {
        background-color: rgba(0, 0, 0, 0.5);
    }
    
    .modal-content {
        background: rgba(17, 17, 17, 0.95);
        padding: 2rem;
        border-radius: 20px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.6);
        border: 1px solid rgba(147, 51, 234, 0.3);
    }

    [data-theme="light"] .modal-content {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(147, 51, 234, 0.2);
        box-shadow: 0 20px 40px rgba(147, 51, 234, 0.1);
    }
    
    .tool-button {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        padding: 1rem 1.25rem;
        margin-bottom: 0.75rem;
        background: rgba(147,51,234, 0.15);
        border: 1px solid rgba(147,51,234, 0.4);
        border-radius: 12px;
        color: white;
        font-weight: 500;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }

    [data-theme="light"] .tool-button {
        background: rgba(147,51,234, 0.1);
        border: 1px solid rgba(147,51,234, 0.3);
        color: var(--text-primary);
    }
    
    .tool-button:hover { 
        background: rgba(147,51,234, 0.3); 
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(147,51,234,0.2);
    }
    
    .tool-button:active { transform: scale(0.98); }

    /* --- EYES ROW (Chat Only) --- */
    #eyes {
        display: none;
        gap: 2.5rem;
        margin-bottom: 2rem;
        align-items: center;
        justify-content: center;
        pointer-events: none;
    }

    .eye {
        width: 140px;
        height: 110px;
        background: var(--purple);
        border-radius: 25px;
        box-shadow: 0 0 30px var(--purple), 
                    0 0 60px rgba(147,51,234,0.4),
                    0 0 100px rgba(147,51,234,0.1);
        position: relative;
        transition: all 0.3s ease;
        will-change: transform;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-15px) rotate(1deg); }
    }

    /* states */
    .thinking { 
        animation: pulse 1.2s infinite ease-in-out, float 6s ease-in-out infinite; 
    }
    
    .reply { 
        height: 70px; 
        border-radius: 40px; 
        filter: brightness(1.8);
        animation: glow 2s infinite alternate;
    }
    
    .talking { 
        animation: bounce-chat 0.6s infinite alternate ease-in-out, float 6s ease-in-out infinite; 
    }

    @keyframes pulse { 
        0% { transform: scale(1) rotate(0deg); } 
        50% { transform: scale(0.9) rotate(1deg); } 
        100% { transform: scale(1) rotate(0deg); } 
    }
    
    @keyframes bounce-chat { 
        0% { transform: translateY(0) rotate(0deg); } 
        100% { transform: translateY(-12px) rotate(1deg); } 
    }
    
    @keyframes glow {
        from { box-shadow: 0 0 30px var(--purple), 0 0 60px rgba(147,51,234,0.6); }
        to { box-shadow: 0 0 40px var(--purple), 0 0 80px rgba(147,51,234,0.8); }
    }

    /* --- CHAT UI --- */
    #chat-view { display: none; }
    
    #chat-container {
        max-height: 60vh;
        overflow-y: auto;
        width: 480px;
        padding: 1.5rem;
    }

    #chat-container::-webkit-scrollbar { width: 8px; }
    #chat-container::-webkit-scrollbar-thumb { 
        background: var(--purple); 
        border-radius: 10px;
        background: linear-gradient(180deg, var(--purple), var(--purple-2));
    }
    #chat-container::-webkit-scrollbar-track { 
        background: rgba(255,255,255,0.05); 
        border-radius: 10px;
    }

    [data-theme="light"] #chat-container::-webkit-scrollbar-track {
        background: rgba(147, 51, 234, 0.1);
    }

    .message {
        margin-bottom: 1rem;
        padding: 1rem 1.25rem;
        border-radius: 18px;
        max-width: 85%;
        line-height: 1.5;
        word-wrap: break-word;
        white-space: pre-wrap;
        animation: messageSlide 0.4s ease-out;
        backdrop-filter: blur(10px);
    }
    
    @keyframes messageSlide {
        from {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    
    .user-message {
        background: linear-gradient(135deg, var(--purple), var(--purple-2));
        color: #fff;
        margin-left: auto;
        text-align: right;
        border-bottom-right-radius: 6px;
        box-shadow: 0 4px 15px rgba(147,51,234,0.3);
    }
    
    .bot-message {
        background: rgba(39, 39, 42, 0.8);
        color: #fff;
        margin-right: auto;
        border-bottom-left-radius: 6px;
        border: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    [data-theme="light"] .bot-message {
        background: rgba(248, 250, 252, 0.9);
        color: var(--text-primary);
        border: 1px solid rgba(147, 51, 234, 0.2);
        box-shadow: 0 4px 15px rgba(147, 51, 234, 0.1);
    }
    
    .tool-message {
        background: rgba(51, 51, 51, 0.8);
        color: #ddd;
        font-style: italic;
        text-align: center;
        margin: 1rem auto;
        max-width: 90%;
        border-radius: 12px;
        font-size: 0.9rem;
        border: 1px solid rgba(147,51,234,0.3);
    }

    [data-theme="light"] .tool-message {
        background: rgba(147, 51, 234, 0.1);
        color: var(--text-primary);
        border: 1px solid rgba(147, 51, 234, 0.2);
    }

    /* Typing Indicator */
    #typing-indicator {
        display: none;
        margin: 1rem 0;
    }
    
    .typing-dots {
        display: flex;
        gap: 6px;
        padding: 1.25rem 1.5rem;
        background: rgba(39, 39, 42, 0.8);
        border-radius: 18px;
        border-bottom-left-radius: 6px;
        max-width: 85px;
        border: 1px solid rgba(255,255,255,0.1);
    }

    [data-theme="light"] .typing-dots {
        background: rgba(248, 250, 252, 0.9);
        border: 1px solid rgba(147, 51, 234, 0.2);
    }
    
    .typing-dots span {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--purple);
        animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typing {
        0%, 80%, 100% { 
            transform: scale(0.8);
            opacity: 0.5;
        }
        40% { 
            transform: scale(1.2);
            opacity: 1;
        }
    }

    /* --- AUTH UI --- */
    #login-view {
        width: 100%;
        max-width: 420px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .auth-card {
        padding: 2.5rem;
        width: 100%;
    }
    
    .input-field {
        width: 100%;
        padding: 1rem 1.25rem;
        margin-bottom: 1.25rem;
        border: 1px solid rgba(147,51,234,0.4);
        border-radius: 12px;
        background: rgba(0,0,0,0.4);
        color: white;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        font-size: 1rem;
    }

    [data-theme="light"] .input-field {
        background: rgba(255, 255, 255, 0.8);
        color: var(--text-primary);
        border: 1px solid rgba(147, 51, 234, 0.3);
    }
    
    .input-field:focus {
        border-color: var(--purple-2);
        outline: none;
        box-shadow: 0 0 0 3px rgba(147,51,234,0.3);
        transform: translateY(-2px);
    }
    
    .input-field::placeholder {
        color: rgba(255,255,255,0.6);
    }

    [data-theme="light"] .input-field::placeholder {
        color: rgba(30, 41, 59, 0.6);
    }
    
    .auth-button {
        width: 100%;
        padding: 1rem 1.25rem;
        background: linear-gradient(135deg, var(--purple), var(--purple-2));
        color: white;
        font-weight: bold;
        border-radius: 12px;
        transition: all 0.3s ease;
        border: none;
        font-size: 1rem;
        box-shadow: 0 4px 15px rgba(147,51,234,0.3);
    }
    
    .auth-button:hover { 
        background: linear-gradient(135deg, var(--purple-2), #c084fc);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(147,51,234,0.4);
    }
    
    .auth-button:active { 
        transform: translateY(0);
    }
    
    .auth-button:disabled { 
        background: #4a5568; 
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    /* Nav */
    #header { 
        position: fixed; 
        top: 1.5rem; 
        right: 1.5rem; 
        z-index: 1000; 
        display: none;
        gap: 0.5rem;
    }
    
    #menu-icon, #theme-toggle {
        background: rgba(147,51,234,0.2);
        border: 1px solid rgba(147,51,234,0.4);
        border-radius: 12px;
        padding: 0.75rem;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    [data-theme="light"] #menu-icon,
    [data-theme="light"] #theme-toggle {
        background: rgba(147, 51, 234, 0.1);
        border: 1px solid rgba(147, 51, 234, 0.3);
    }
    
    #menu-icon:hover, #theme-toggle:hover {
        background: rgba(147,51,234,0.3);
        transform: scale(1.1);
    }
    
    #nav-menu {
        position: fixed;
        top: 0;
        right: 0;
        height: 100vh;
        z-index: 990;
        transform: translateX(100%);
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: -5px 0 30px rgba(0,0,0,0.5);
        background: rgba(17, 17, 17, 0.95);
        border-left: 1px solid rgba(147,51,234,0.2);
        padding: 2.5rem;
        backdrop-filter: blur(20px);
        width: 280px;
    }

    [data-theme="light"] #nav-menu {
        background: rgba(255, 255, 255, 0.95);
        border-left: 1px solid rgba(147, 51, 234, 0.2);
        box-shadow: -5px 0 30px rgba(147, 51, 234, 0.1);
    }
    
    #nav-menu.active { transform: translateX(0); }
    
    #nav-menu a, #nav-menu button {
        padding: 1rem 1.25rem;
        margin-bottom: 0.5rem;
        border-radius: 10px;
        transition: all 0.3s ease;
        text-align: left;
        border: none;
        background: none;
        color: white;
        font-size: 1rem;
        width: 100%;
    }

    [data-theme="light"] #nav-menu a,
    [data-theme="light"] #nav-menu button {
        color: var(--text-primary);
    }
    
    #nav-menu a:hover, #nav-menu button:hover {
        background: rgba(147,51,234,0.2);
        transform: translateX(5px);
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        body {
            padding: 1rem;
        }
        
        #chat-container {
            width: 100%;
            max-width: 100%;
            max-height: 55vh;
        }
        
        #input-form {
            width: 100%;
        }
        
        .eye {
            width: 100px;
            height: 80px;
        }
        
        #eyes {
            gap: 1.5rem;
        }
        
        .auth-card {
            padding: 2rem 1.5rem;
        }
        
        #nav-menu {
            width: 100%;
        }
    }

    /* Particle Canvas */
    #particle-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: -1;
    }

    [data-theme="light"] #particle-canvas {
        display: none;
    }

    /* Theme Toggle Animation */
    .theme-icon {
        transition: all 0.3s ease;
    }

    [data-theme="dark"] .sun-icon {
        display: none;
    }

    [data-theme="light"] .moon-icon {
        display: none;
    }

    [data-theme="dark"] .moon-icon {
        display: block;
    }

    [data-theme="light"] .sun-icon {
        display: block;
    }
</style>
</head>

<body data-theme="dark">
    <!-- Particle Background -->
    <canvas id="particle-canvas"></canvas>

    <!-- --- MODAL FOR GEMINI TOOLS --- -->
    <div id="tool-modal" class="modal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4 text-center" style="color:var(--purple-2);">‚ú® AI Tools ‚ú®</h3>
            <p class="text-sm text-gray-400 mb-6 text-center">Analyze your current conversation:</p>

            <button class="tool-button" onclick="handleGeminiTool('summarize')">
                <span>Summarize Conversation</span>
                <span class="text-lg text-yellow-300">üìù</span>
            </button>
            <button class="tool-button" onclick="handleGeminiTool('suggest')">
                <span>Suggest Next Steps</span>
                <span class="text-lg text-cyan-300">üí°</span>
            </button>
            <button class="tool-button" onclick="handleGeminiTool('tasks')">
                <span>Generate a Task List</span>
                <span class="text-lg text-green-300">‚úÖ</span>
            </button>
            
            <button class="auth-button mt-6 bg-gray-700 hover:bg-gray-600" onclick="document.getElementById('tool-modal').style.display = 'none'">
                Close
            </button>
        </div>
    </div>

    <!-- NAV/HEADER (Only visible when logged in) -->
    <div id="header" class="p-4 flex">
        <div id="theme-toggle" class="text-xl mr-2">
            <span class="theme-icon sun-icon">‚òÄÔ∏è</span>
            <span class="theme-icon moon-icon">üåô</span>
        </div>
        <div id="menu-icon" class="text-xl">‚ò∞</div>
    </div>

    <div id="nav-menu" class="">
        <a href="#" id="about-link" class="block text-white">About Btl</a>
        <a href="#" id="contact-link" class="block text-white">Contact Info</a>
        <button id="logout-button" class="block text-var(--purple) font-bold w-full text-left mt-4">Logout</button>
    </div>

    <!-- --- 1. AUTHENTICATION VIEW --- -->
    <div id="login-view">
        <h1 class="text-5xl font-black mb-2 text-center bg-gradient-to-r from-purple-400 to-purple-600 bg-clip-text text-transparent">Btl AI</h1>
        <p class="text-gray-400 text-center mb-8">Your Intelligent Assistant</p>
        
        <div class="auth-card glass-container">
            <!-- Shared Error/Message Display -->
            <div id="auth-message" class="mb-4 p-3 bg-red-800/50 text-red-300 rounded-lg text-sm hidden"></div>

            <!-- Login Form -->
            <form id="login-form" class="auth-form">
                <h2 class="text-2xl font-semibold mb-6 text-white text-center">Welcome Back</h2>
                <input type="email" id="login-email" class="input-field" placeholder="Email Address" required>
                <input type="password" id="login-password" class="input-field" placeholder="Password" required>
                <button type="submit" id="login-button" class="auth-button">Sign In</button>
                <p class="mt-4 text-center text-sm text-gray-400">
                    Need an account? <a href="#" id="show-register" class="text-purple-400 hover:text-purple-300 font-medium transition-colors">Register</a>
                </p>
            </form>

            <!-- Register Form (Initially Hidden) -->
            <form id="register-form" class="auth-form hidden">
                <h2 class="text-2xl font-semibold mb-6 text-white text-center">Create Account</h2>
                <input type="email" id="register-email" class="input-field" placeholder="Email Address" required>
                <input type="password" id="register-password" class="input-field" placeholder="Password" required>
                <input type="password" id="register-confirm-password" class="input-field" placeholder="Confirm Password" required>
                <button type="submit" id="register-button" class="auth-button">Create Account</button>
                <p class="mt-4 text-center text-sm text-gray-400">
                    Already have an account? <a href="#" id="show-login" class="text-purple-400 hover:text-purple-300 font-medium transition-colors">Sign In</a>
                </p>
            </form>
        </div>
    </div>

    <!-- --- 2. CHAT VIEW (Initially Hidden) --- -->
    <div id="chat-view" class="flex flex-col items-center gap-4">
        <!-- Eyes row: the two purple squares -->
        <div id="eyes" class="mb-4">
            <div id="eyeL" class="eye" aria-hidden="true"></div>
            <div id="eyeR" class="eye" aria-hidden="true"></div>
        </div>

        <div id="chat-content" class="flex flex-col items-center gap-4">
            <div id="chat-container" class="glass-container">
                <!-- messages go here -->
            </div>

            <!-- Typing Indicator -->
            <div id="typing-indicator" class="self-start ml-4">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>

            <form id="input-form" class="flex w-[480px] max-w-full gap-2">
                <button type="button" id="tool-button" class="px-4 py-4 bg-gray-700/80 text-white font-bold rounded-2xl hover:bg-gray-600/80 transition-all duration-300 transform hover:scale-105 active:scale-95 text-xl backdrop-blur-sm border border-gray-600" title="AI Tools">
                    ‚ú®
                </button>
                <input type="text" id="user-input" placeholder="Type your message..." required
                    class="flex-grow p-4 border border-purple-500/50 rounded-2xl bg-gray-900/80 text-white text-base focus:ring-2 focus:ring-purple-400 focus:outline-none backdrop-blur-sm transition-all duration-300 placeholder-gray-400">
                <button type="submit" id="send-button" class="px-6 py-4 bg-gradient-to-r from-[#9333ea] to-[#a855f7] text-white font-bold rounded-2xl hover:from-[#a855f7] hover:to-[#c084fc] transition-all duration-300 transform hover:scale-105 active:scale-95 shadow-lg">
                    Send
                </button>
            </form>
        </div>
    </div>

<script>

     crossorigin="anonymous"
    // --- Safe DOM references ---
    const chatView = document.getElementById("chat-view");
    const chatContainer = document.getElementById("chat-container");
    const inputForm = document.getElementById("input-form");
    const userInput = document.getElementById("user-input");
    const sendButton = document.getElementById("send-button");
    const toolButton = document.getElementById("tool-button");
    const toolModal = document.getElementById("tool-modal");
    const eyeL = document.getElementById("eyeL");
    const eyeR = document.getElementById("eyeR");
    const typingIndicator = document.getElementById("typing-indicator");
    const themeToggle = document.getElementById("theme-toggle");

    const header = document.getElementById("header");
    const navMenu = document.getElementById("nav-menu");
    const menuIcon = document.getElementById("menu-icon");
    const logoutButton = document.getElementById("logout-button");
    const aboutLink = document.getElementById("about-link");
    const contactLink = document.getElementById("contact-link");

    const loginView = document.getElementById("login-view");
    const loginForm = document.getElementById("login-form");
    const registerForm = document.getElementById("register-form");
    const authMessage = document.getElementById("auth-message");
    const showRegisterLink = document.getElementById("show-register");
    const showLoginLink = document.getElementById("show-login");

    let chatHistory = [];
    const initialMessage = "Welcome back! What can I help you with today?";
    const API_BASE = '';

    // --- PWA INSTALLATION FEATURES ---
    let deferredPrompt;
    const installButton = document.createElement('button');

    // Create install button
    function createInstallButton() {
        installButton.innerHTML = 'üì± Install Btl AI';
        installButton.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--purple), var(--purple-2));
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(147,51,234,0.3);
            z-index: 1000;
            transition: all 0.3s ease;
            font-size: 14px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        `;
        installButton.addEventListener('mouseenter', () => {
            installButton.style.transform = 'translateY(-2px)';
            installButton.style.boxShadow = '0 6px 20px rgba(147,51,234,0.4)';
        });
        installButton.addEventListener('mouseleave', () => {
            installButton.style.transform = 'translateY(0)';
            installButton.style.boxShadow = '0 4px 15px rgba(147,51,234,0.3)';
        });
        installButton.addEventListener('click', installPWA);
        document.body.appendChild(installButton);
        installButton.style.display = 'none';
    }

    // Handle before install prompt
    window.addEventListener('beforeinstallprompt', (e) => {
        console.log('üì± PWA install prompt available');
        e.preventDefault();
        deferredPrompt = e;
        installButton.style.display = 'block';
        
        // Auto-hide after 10 seconds
        setTimeout(() => {
            if (installButton.style.display !== 'none') {
                installButton.style.display = 'none';
            }
        }, 10000);
    });

    // Install PWA function
    async function installPWA() {
        if (!deferredPrompt) return;
        
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        
        if (outcome === 'accepted') {
            console.log('‚úÖ User accepted PWA installation');
            installButton.style.display = 'none';
        } else {
            console.log('‚ùå User dismissed PWA installation');
        }
        
        deferredPrompt = null;
    }

    // Check if app is already installed
    window.addEventListener('appinstalled', () => {
        console.log('üéâ Btl AI was successfully installed');
        installButton.style.display = 'none';
        deferredPrompt = null;
        
        // Show welcome message for installed app
        if (chatHistory.length === 0) {
            setTimeout(() => {
                addMessage("Hey! Thanks for installing Btl AI! üéâ Now I'm always just a tap away on your home screen. How can I help you today?", 'bot');
            }, 1000);
        }
    });

    // Detect if running as PWA
    function isRunningAsPWA() {
        return window.matchMedia('(display-mode: standalone)').matches || 
               window.navigator.standalone ||
               document.referrer.includes('android-app://');
    }

    // Enhanced offline detection
    function checkOnlineStatus() {
        if (!navigator.onLine) {
            addMessage("üì° Looks like you're offline! I'll try to reconnect when you're back online.", 'bot');
        }
    }

    // Network status listeners
    window.addEventListener('online', () => {
        console.log('‚úÖ Back online');
        addMessage("‚úÖ I'm back online! Ready to chat! üòä", 'bot');
    });

    window.addEventListener('offline', () => {
        console.log('‚ùå Went offline');
        addMessage("üì° I'm having trouble connecting. Check your internet connection.", 'bot');
    });

    // Initialize PWA features
    function initializePWA() {
        createInstallButton();
        checkOnlineStatus();
        
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('‚úÖ Service Worker registered:', registration);
                    })
                    .catch((error) => {
                        console.log('‚ùå Service Worker registration failed:', error);
                    });
            });
        }
        
        // If running as PWA, enhance the experience
        if (isRunningAsPWA()) {
            console.log('üì± Running as installed PWA');
            document.title = "Btl AI";
            
            // Add PWA-specific styles
            const style = document.createElement('style');
            style.textContent = `
                @media (display-mode: standalone) {
                    body {
                        padding-top: env(safe-area-inset-top);
                        padding-bottom: env(safe-area-inset-bottom);
                        padding-left: env(safe-area-inset-left);
                        padding-right: env(safe-area-inset-right);
                    }
                    
                    #header {
                        top: calc(1.5rem + env(safe-area-inset-top));
                    }
                }
                
                /* Mobile app-like scroll */
                #chat-container {
                    -webkit-overflow-scrolling: touch;
                }
            `;
            document.head.appendChild(style);
        }
    }

    // --- THEME MANAGEMENT ---
    function initTheme() {
        const savedTheme = localStorage.getItem('btl-theme') || 'dark';
        document.body.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);
    }

    function toggleTheme() {
        const currentTheme = document.body.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        
        document.body.setAttribute('data-theme', newTheme);
        localStorage.setItem('btl-theme', newTheme);
        updateThemeIcon(newTheme);
        
        // Reinitialize particles if switching to dark mode
        if (newTheme === 'dark') {
            initParticles();
        }
    }

    function updateThemeIcon(theme) {
        const sunIcon = document.querySelector('.sun-icon');
        const moonIcon = document.querySelector('.moon-icon');
        
        if (theme === 'dark') {
            sunIcon.style.display = 'none';
            moonIcon.style.display = 'block';
        } else {
            sunIcon.style.display = 'block';
            moonIcon.style.display = 'none';
        }
    }

    // --- CREDENTIALS REMEMBERING ---
    function rememberCredentials(email, password) {
        if (email && password) {
            localStorage.setItem('btl-remembered-email', email);
            // Note: In production, you should never store passwords in localStorage
            // This is just for demo purposes
            localStorage.setItem('btl-remembered-password', password);
        }
    }

    function loadRememberedCredentials() {
        const email = localStorage.getItem('btl-remembered-email');
        const password = localStorage.getItem('btl-remembered-password');
        
        if (email) {
            document.getElementById('login-email').value = email;
        }
        if (password) {
            document.getElementById('login-password').value = password;
        }
    }

    function clearRememberedCredentials() {
        localStorage.removeItem('btl-remembered-email');
        localStorage.removeItem('btl-remembered-password');
    }

    // --- PARTICLE BACKGROUND ---
    function initParticles() {
        const canvas = document.getElementById('particle-canvas');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        const particles = [];
        const particleCount = 40;
        
        for (let i = 0; i < particleCount; i++) {
            particles.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                size: Math.random() * 2 + 1,
                speedX: (Math.random() - 0.5) * 0.3,
                speedY: (Math.random() - 0.5) * 0.3,
                opacity: Math.random() * 0.5 + 0.2
            });
        }
        
        function animate() {
            // Only animate if in dark mode and canvas is visible
            if (document.body.getAttribute('data-theme') !== 'dark') {
                return;
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            particles.forEach(particle => {
                particle.x += particle.speedX;
                particle.y += particle.speedY;
                
                if (particle.x < 0 || particle.x > canvas.width) particle.speedX *= -1;
                if (particle.y < 0 || particle.y > canvas.height) particle.speedY *= -1;
                
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(147, 51, 234, ${particle.opacity})`;
                ctx.fill();
            });
            
            requestAnimationFrame(animate);
        }
        
        animate();
        
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
    }

    // --- UTILITIES ---
    function showAuthMessage(message, isError = true) {
        authMessage.textContent = message;
        authMessage.classList.remove('hidden', 'bg-red-800/50', 'bg-green-800/50');
        authMessage.classList.add(isError ? 'bg-red-800/50' : 'bg-green-800/50');
        setTimeout(() => authMessage.classList.add('hidden'), 5000);
    }
    
    function setAuthButtonsDisabled(disabled) {
        document.getElementById("login-button").disabled = disabled;
        document.getElementById("register-button").disabled = disabled;
    }

    function setChatEnabled(enabled) {
        sendButton.disabled = !enabled;
        toolButton.disabled = !enabled;
        userInput.disabled = !enabled;
    }

    function closeModal(event) {
        if (event.target === toolModal) {
            toolModal.style.display = 'none';
        }
    }

    function showTypingIndicator() {
        typingIndicator.style.display = 'block';
    }

    function hideTypingIndicator() {
        typingIndicator.style.display = 'none';
    }

    // --- VIEW MANAGEMENT ---
    function showAuthView() {
        sessionStorage.removeItem('authToken');
        header.style.display = 'none';
        chatView.style.display = 'none';
        document.getElementById("eyes").style.display = 'none';
        loginView.style.display = 'flex';
        loginForm.reset();
        registerForm.reset();
        chatHistory = [];
        chatContainer.innerHTML = '';
        hideTypingIndicator();
        
        // Load remembered credentials
        loadRememberedCredentials();
    }

    function showChatView() {
        header.style.display = 'flex';
        loginView.style.display = 'none';
        chatView.style.display = 'flex';
        document.getElementById("eyes").style.display = 'flex';
        loadChatHistory();
    }
    
    // --- CHAT LOGIC ---
    function setState(state) {
        eyeL.className = "eye";
        eyeR.className = "eye";
        if (state) {
            eyeL.classList.add(state);
            eyeR.classList.add(state);
        }
    }

    function addMessage(text, sender, isNewMessage = true, isTool = false) {
        const messageDiv = document.createElement('div');
        
        if (isTool) {
            messageDiv.classList.add('message', 'tool-message');
        } else if (sender === 'user') {
            messageDiv.classList.add('message', 'user-message');
        } else {
            messageDiv.classList.add('message', 'bot-message');
        }
        
        messageDiv.textContent = text;
        chatContainer.appendChild(messageDiv);
        
        if (isNewMessage && !isTool) {
            const normalizedRole = sender === 'user' ? 'user' : 'bot';
            chatHistory.push({ role: normalizedRole, text });
            sessionStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        }

        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    async function loadChatHistory() {
        const authToken = sessionStorage.getItem('authToken');
        chatContainer.innerHTML = '';
        chatHistory = [];

        if (!authToken) {
            addMessage(initialMessage, 'bot');
            return;
        }

        try {
            const resp = await fetch(API_BASE + '/api/messages', {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${authToken}` }
            });

            if (resp.ok) {
                const data = await resp.json();
                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(msg => {
                        const displayRole = msg.role === 'user' ? 'user' : 'bot';
                        addMessage(msg.text, displayRole, false);
                    });
                    
                    chatHistory = data.messages.map(msg => ({
                        role: msg.role === 'user' ? 'user' : 'bot',
                        text: msg.text
                    }));
                    
                    sessionStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                    
                    if (data.messages.length === 0) {
                        addMessage(initialMessage, 'bot');
                    }
                    return;
                }
            }
            
            const savedHistory = sessionStorage.getItem('chatHistory');
            if (savedHistory) {
                try {
                    const parsedHistory = JSON.parse(savedHistory);
                    parsedHistory.forEach(m => {
                        const displayRole = m.role === 'user' ? 'user' : 'bot';
                        addMessage(m.text, displayRole, false);
                    });
                    chatHistory = parsedHistory;
                } catch (e) {
                    addMessage(initialMessage, 'bot');
                }
            } else {
                addMessage(initialMessage, 'bot');
            }
        } catch (err) {
            console.error('Failed to load message history:', err);
            const savedHistory = sessionStorage.getItem('chatHistory');
            if (savedHistory) {
                try {
                    const parsedHistory = JSON.parse(savedHistory);
                    parsedHistory.forEach(m => {
                        const displayRole = m.role === 'user' ? 'user' : 'bot';
                        addMessage(m.text, displayRole, false);
                    });
                    chatHistory = parsedHistory;
                } catch (e) {
                    addMessage(initialMessage, 'bot');
                }
            } else {
                addMessage(initialMessage, 'bot');
            }
        }
    }

    async function handleChat(event) {
        event.preventDefault();
        const userMessage = userInput.value.trim();
        if (!userMessage) return;

        addMessage(userMessage, 'user');
        userInput.value = '';
        setChatEnabled(false);
        showTypingIndicator();
        setState('thinking');

        const authToken = sessionStorage.getItem('authToken');
        if (!authToken) {
            showAuthMessage("Session expired. Please log in again.", true);
            showAuthView();
            return;
        }

        try {
            const historyToSend = chatHistory
                .filter(msg => msg.role !== 'system')
                .map(m => ({
                    role: m.role === 'bot' ? 'model' : 'user',
                    parts: [{ text: m.text }]
                }));

            const resp = await fetch(API_BASE + '/api/chat', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}` 
                },
                body: JSON.stringify({ prompt: userMessage, history: historyToSend })
            });

            const data = await resp.json();

            if (resp.ok && data?.text) {
                hideTypingIndicator();
                setState('reply');
                await new Promise(r => setTimeout(r, 420));
                setState('talking');
                addMessage(data.text, 'bot');
            } else if (resp.status === 401) {
                showAuthMessage("Your session expired. Please log in.", true);
                sessionStorage.removeItem('chatHistory');
                showAuthView();
            } else {
                hideTypingIndicator();
                const errorMsg = data?.text || data?.error || "The AI service is currently unavailable.";
                addMessage("Error: " + errorMsg, 'bot');
            }
        } catch (err) {
            console.error('Chat error:', err);
            hideTypingIndicator();
            addMessage("Network Error: Could not connect to the server.", 'bot');
        } finally {
            setChatEnabled(true);
            setTimeout(() => setState(''), 800);
        }
    }

    // --- GEMINI TOOL LOGIC ---
    async function handleGeminiTool(toolType) {
        toolModal.style.display = 'none';

        if (chatHistory.length <= 1) {
            addMessage("Conversation history is too short. Try chatting a bit first!", 'bot', true, true);
            return;
        }

        const authToken = sessionStorage.getItem('authToken');
        if (!authToken) {
            showAuthMessage("Session expired. Please log in again.", true);
            showAuthView();
            return;
        }

        addMessage(`Running AI Tool: ${toolType.charAt(0).toUpperCase() + toolType.slice(1)}...`, 'system', false, true);
        setChatEnabled(false);
        showTypingIndicator();
        setState('thinking');

        try {
            const resp = await fetch(API_BASE + `/api/tool/${toolType}`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}` 
                },
                body: JSON.stringify({ history: chatHistory })
            });

            const data = await resp.json();

            if (resp.ok && data?.text) {
                hideTypingIndicator();
                setState('reply');
                await new Promise(r => setTimeout(r, 420));
                setState('talking');
                addMessage(data.text, 'bot');
            } else if (resp.status === 401) {
                showAuthMessage("Your session expired. Please log in.", true);
                sessionStorage.removeItem('chatHistory');
                showAuthView();
            } else {
                hideTypingIndicator();
                addMessage(`Tool Error: ${data.message || data.error || 'Failed to process AI tool request.'}`, 'system', false, true);
            }
        } catch (err) {
            console.error('Tool error:', err);
            hideTypingIndicator();
            addMessage("Network Error: Could not connect to the tool server.", 'system', false, true);
        } finally {
            setChatEnabled(true);
            setTimeout(() => setState(''), 800);
        }
    }

    // --- AUTHENTICATION LOGIC ---
    async function handleAuth(event, endpoint) {
        event.preventDefault();
        setAuthButtonsDisabled(true);
        authMessage.classList.add('hidden');

        const formId = endpoint === 'login' ? 'login-' : 'register-';
        const email = document.getElementById(formId + 'email').value;
        const password = document.getElementById(formId + 'password').value;
        const confirmPassword = endpoint === 'register' ? document.getElementById('register-confirm-password').value : null;

        if (endpoint === 'register' && password !== confirmPassword) {
            showAuthMessage("Passwords do not match.", true);
            setAuthButtonsDisabled(false);
            return;
        }

        try {
            const payload = { email, password };
            if (endpoint === 'register') payload.username = email;

            const resp = await fetch(API_BASE + `/api/auth/${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await resp.json();

            if (resp.ok && data.token) {
                // Remember credentials
                rememberCredentials(email, password);
                
                sessionStorage.setItem('authToken', data.token);
                sessionStorage.removeItem('chatHistory'); 
                showChatView();
            } else {
                showAuthMessage(data.message || `Authentication failed: ${data.error || 'Unknown error'}`, true);
            }
        } catch (err) {
            showAuthMessage("Network error. Could not connect to the authentication server.", true);
            console.error(err);
        } finally {
            setAuthButtonsDisabled(false);
        }
    }

    // --- EYE TRACKING LOGIC ---
    function initializeEyeTracking() {
        const MAX_DIST = 14;

        function onMove(clientX, clientY) {
            if (chatView.style.display !== 'flex') return;

            [eyeL, eyeR].forEach(eye => {
                const rect = eye.getBoundingClientRect();
                const cx = rect.left + rect.width / 2;
                const cy = rect.top + rect.height / 2;

                const dx = clientX - cx;
                const dy = clientY - cy;

                const angle = Math.atan2(dy, dx);
                const dist = Math.min(MAX_DIST, Math.hypot(dx, dy) * 0.06);

                const x = Math.cos(angle) * dist;
                const y = Math.sin(angle) * dist;

                eye.style.transform = `translate3d(${x}px, ${y}px, 0)`;
            });
        }

        document.addEventListener('mousemove', (e) => onMove(e.clientX, e.clientY));
        document.addEventListener('touchmove', (e) => {
            if (e.touches[0]) onMove(e.touches[0].clientX, e.touches[0].clientY);
        });

        document.addEventListener('mouseleave', () => {
            eyeL.style.transform = '';
            eyeR.style.transform = '';
        });
    }

    // --- INITIALIZATION ---
    function initializeApp() {
        // Initialize PWA features first
        initializePWA();
        
        // Then initialize your existing app features
        initTheme();
        initParticles();

        // Theme toggle event
        themeToggle.addEventListener('click', toggleTheme);

        // Form Submission Handlers
        loginForm.addEventListener('submit', (e) => handleAuth(e, 'login'));
        registerForm.addEventListener('submit', (e) => handleAuth(e, 'register'));

        // Auth View Toggles
        showRegisterLink.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
        });
        
        showLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
        });

        // Chat & Nav Handlers
        inputForm.addEventListener('submit', handleChat);
        
        toolButton.addEventListener('click', () => { 
            if (toolButton.disabled) return;
            toolModal.style.display = 'flex'; 
        });
        
        menuIcon.addEventListener('click', () => navMenu.classList.toggle('active'));
        
        logoutButton.addEventListener('click', () => { 
            sessionStorage.removeItem('authToken'); 
            sessionStorage.removeItem('chatHistory'); 
            clearRememberedCredentials();
            navMenu.classList.remove('active');
            showAuthView(); 
        });

        // Simple alerts for nav links
        aboutLink.addEventListener('click', e => { 
            e.preventDefault(); 
            alert("Btl AI ‚Äî Your intelligent assistant created with ‚ô° by red4 . Btl AI helps you with conversations, task planning, and information analysis with advanced AI tools."); 
            navMenu.classList.remove('active'); 
        });
        
        contactLink.addEventListener('click', e => { 
            e.preventDefault(); 
            alert("Contact Information:\n\nEmail: btlreda852@gmail.com\nWebsite: coming soon\nSupport Hours: 24/7\n\nFor technical support or inquiries, please reach out to our team."); 
            navMenu.classList.remove('active'); 
        });

        // Initial Auth Check
        const token = sessionStorage.getItem('authToken');
        if (token) {
            showChatView();
        } else {
            showAuthView();
        }

        initializeEyeTracking();
    }

    // Start the app
    initializeApp();
</script>
</body>
</html>
